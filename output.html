<span title='c'>// Code from repo https://github.com/Gonkee/Gepe3D</span> <br> <span title='k'>using</span> System; <br> <span title='k'>using</span> System.Collections.Generic; <br> <span title='k'>using</span> OpenTK.Compute.OpenCL; <br> <span title='k'>using</span> OpenTK.Mathematics; <br><span title='o'>  </span><br> <span title='k'>namespace</span> Gepe3D <br> <span title='p'>{</span> <br> &emsp;<span title='k'>public</span> <span title='k'>class</span> ParticleSystem <br> &emsp;<span title='p'>{</span> <br> &emsp;&emsp;<span title='c'>/* <br> &emsp;&emsp;&emsp;Block comment <br> &emsp;&emsp;*/</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='c'>// Render</span> <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>int</span> quad_VAO; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>int</span> quad_VBO; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>int</span> instancePositions_VBO; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>int</span> instanceColours_VBO; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> Shader particleShader; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='c'>// Update</span> <br> &emsp;&emsp;CLCommandQueue queue; <br> &emsp;&emsp;CLEvent @event<span title='o'> = </span><span title='k'>new</span> <span title='f'>CLEvent</span><span title='p'>(</span><span title='p'>)</span>; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>readonly</span> <span title='k'>int</span> ParticleCount; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>int</span> cellCount; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>float</span> <span title='p'>[</span><span title='p'>]</span> posData; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>float</span> <span title='p'>[</span><span title='p'>]</span> ePosData; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>float</span> <span title='p'>[</span><span title='p'>]</span> velData; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>float</span> <span title='p'>[</span><span title='p'>]</span> colourData; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> <span title='k'>int</span> <span title='p'>[</span><span title='p'>]</span><span title='o'>  </span> phaseData; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>static</span> Vector3 GRAVITY&emsp;&emsp;<span title='o'>  </span>= <span title='k'>new</span> <span title='f'>Vector3</span><span title='p'>(</span>-3, -6, 0<span title='p'>)</span>; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>static</span> <span title='k'>float</span><span title='o'>  </span> PARTICLE_RADIUS<span title='o'>  </span>= 0.2f; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>static</span> <span title='k'>float</span><span title='o'>  </span> GRID_CELL_WIDTH<span title='o'>  </span>= 0.6f; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>static</span> <span title='k'>float</span><span title='o'>  </span> KERNEL_SIZE&emsp;<span title='o'>  </span>= 0.6f; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>static</span> <span title='k'>float</span><span title='o'>  </span> REST_DENSITY&emsp;<span title='o'> = </span>80f; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>static</span> <span title='k'>int</span> <br> &emsp;&emsp;&emsp;GridRowsX<span title='o'> = </span>16, <br> &emsp;&emsp;&emsp;GridRowsY<span title='o'> = </span>10, <br> &emsp;&emsp;&emsp;GridRowsZ<span title='o'> = </span>12; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>static</span> <span title='k'>float</span> <br> &emsp;&emsp;&emsp;MAX_X<span title='o'> = </span>GRID_CELL_WIDTH<span title='o'> * </span>GridRowsX, <br> &emsp;&emsp;&emsp;MAX_Y<span title='o'> = </span>GRID_CELL_WIDTH<span title='o'> * </span>GridRowsY, <br> &emsp;&emsp;&emsp;MAX_Z<span title='o'> = </span>GRID_CELL_WIDTH<span title='o'> * </span>GridRowsZ; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>static</span> <span title='k'>int</span> <br> &emsp;&emsp;&emsp;PHASE_LIQUID<span title='o'> = </span>0, <br> &emsp;&emsp;&emsp;PHASE_SOLID<span title='o'> = </span>1, <br> &emsp;&emsp;&emsp;PHASE_STATIC<span title='o'> = </span>2; <br> &emsp;&emsp; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> CLKernel <br> &emsp;&emsp;&emsp;k_PredictPos, <br> &emsp;&emsp;&emsp;k_CalcLambdas, <br> &emsp;&emsp;&emsp;k_FluidCorrect, <br> &emsp;&emsp;&emsp;k_CorrectPredictions, <br> &emsp;&emsp;&emsp;k_UpdateVel, <br> &emsp;&emsp;&emsp;k_CalcVorticity, <br> &emsp;&emsp;&emsp;k_ApplyVortVisc, <br> &emsp;&emsp;&emsp;k_CorrectVel, <br> &emsp;&emsp;&emsp;k_AssignParticleCells, <br> &emsp;&emsp;&emsp;k_FindCellsStartAndEnd, <br> &emsp;&emsp;&emsp;k_SortParticleIDsByCell, <br> &emsp;&emsp;&emsp;k_SolidCorrect; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>readonly</span> CLBuffer <br> &emsp;&emsp;&emsp;b_Pos,&emsp;&emsp;&emsp;<span title='o'>  </span><span title='c'>// positions</span> <br> &emsp;&emsp;&emsp;b_Vel,&emsp;&emsp;&emsp;<span title='o'>  </span><span title='c'>// velocities</span> <br> &emsp;&emsp;&emsp;b_ePos,&emsp;&emsp;&emsp; <span title='c'>// estimated positions</span> <br> &emsp;&emsp;&emsp;b_imass,&emsp;&emsp;&emsp;<span title='c'>// inverse masses</span> <br> &emsp;&emsp;&emsp;b_lambdas,&emsp;&emsp;<span title='o'>  </span><span title='c'>// fluid correction scalar</span> <br> &emsp;&emsp;&emsp;b_phase,&emsp;&emsp;&emsp;<span title='c'>// particle phase</span> <br> &emsp;&emsp;&emsp;b_Vorticities,&emsp;<span title='o'>  </span><span title='c'>// fluid vorticities</span> <br> &emsp;&emsp;&emsp;b_PosCorrection,&emsp;<span title='c'>// position correction</span> <br> &emsp;&emsp;&emsp;b_VelCorrection,&emsp;<span title='c'>// velocity correction</span> <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// buffers <span title='k'>for</span> neighbour search</span> <br> &emsp;&emsp;&emsp;b_sortedParticleIDs, <br> &emsp;&emsp;&emsp;b_cellStartAndEndIDs, <br> &emsp;&emsp;&emsp;b_cellIDsOfParticles, <br> &emsp;&emsp;&emsp;b_numParticlesPerCell, <br> &emsp;&emsp;&emsp;b_particleIDinCell; <br> &emsp;&emsp; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>bool</span> <br> &emsp;&emsp;&emsp;posDirty<span title='o'> = </span>false, <br> &emsp;&emsp;&emsp;velDirty<span title='o'> = </span>false, <br> &emsp;&emsp;&emsp;phaseDirty<span title='o'> = </span>false, <br> &emsp;&emsp;&emsp;colourDirty<span title='o'> = </span>false; <br> &emsp; <br> &emsp;&emsp;List<<span title='p'>(</span><span title='k'>int</span>, <span title='k'>int</span>, <span title='k'>float</span><span title='p'>)</span>> distanceConstraints<span title='o'> = </span><span title='k'>new</span> List<<span title='p'>(</span><span title='k'>int</span>, <span title='k'>int</span>, <span title='k'>float</span><span title='p'>)</span>><span title='p'>(</span><span title='p'>)</span>; <br> &emsp;&emsp; <br> &emsp;&emsp; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='f'>ParticleSystem</span><span title='p'>(</span><span title='k'>int</span> particleCount<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.ParticleCount<span title='o'> = </span>particleCount; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.cellCount<span title='o'> = </span>GridRowsX<span title='o'> * </span>GridRowsY<span title='o'> * </span>GridRowsZ; <br> &emsp;&emsp;&emsp;posData&emsp;= <span title='k'>new</span> <span title='k'>float</span><span title='p'>[</span>particleCount<span title='o'> * </span>3<span title='p'>]</span>; <br> &emsp;&emsp;&emsp;velData&emsp;= <span title='k'>new</span> <span title='k'>float</span><span title='p'>[</span>particleCount<span title='o'> * </span>3<span title='p'>]</span>; <br> &emsp;&emsp;&emsp;colourData<span title='o'> = </span><span title='k'>new</span> <span title='k'>float</span><span title='p'>[</span>particleCount<span title='o'> * </span>3<span title='p'>]</span>; <br> &emsp;&emsp;&emsp;ePosData<span title='o'>  </span><span title='o'> = </span><span title='k'>new</span> <span title='k'>float</span><span title='p'>[</span>particleCount<span title='o'> * </span>3<span title='p'>]</span>; <br> &emsp;&emsp;&emsp;phaseData<span title='o'>  </span>= <span title='k'>new</span> <span title='k'>int</span><span title='o'>  </span><span title='p'>[</span>particleCount<span title='p'>]</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>///////////////////</span> <br> &emsp;&emsp;&emsp;<span title='c'>// Set up OpenCL //</span> <br> &emsp;&emsp;&emsp;<span title='c'>///////////////////</span> <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// set up context & queue</span> <br> &emsp;&emsp;&emsp;CLResultCode result; <br> &emsp;&emsp;&emsp;CLPlatform<span title='p'>[</span><span title='p'>]</span> platforms; <br> &emsp;&emsp;&emsp;CLDevice<span title='p'>[</span><span title='p'>]</span> devices; <br> &emsp;&emsp;&emsp;result<span title='o'> = </span>CL.<span title='f'>GetPlatformIds</span><span title='p'>(</span><span title='k'>out</span> platforms<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;result<span title='o'> = </span>CL.<span title='f'>GetDeviceIds</span><span title='p'>(</span>platforms<span title='p'>[</span>0<span title='p'>]</span>, DeviceType.Gpu, <span title='k'>out</span> devices<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>if</span> <span title='p'>(</span>result<span title='o'> == </span>CLResultCode.DeviceNotFound<span title='p'>)</span> <span title='p'>{</span> <br> &emsp;&emsp;&emsp;&emsp;CL.<span title='f'>GetDeviceIds</span><span title='p'>(</span>platforms<span title='p'>[</span>0<span title='p'>]</span>, DeviceType.All, <span title='k'>out</span> devices<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;&emsp;System.Console.<span title='f'>WriteLine</span><span title='p'>(</span><span title='s'>"Failed to initiate OpenCL <span title='k'>using</span> GPU, cannot use hardware acceleration"</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp;&emsp;CLContext context<span title='o'> = </span>CL.<span title='f'>CreateContext</span><span title='p'>(</span><span title='k'>new</span> <span title='f'>IntPtr</span><span title='p'>(</span><span title='p'>)</span>, 1, devices, <span title='k'>new</span> <span title='f'>IntPtr</span><span title='p'>(</span><span title='p'>)</span>, <span title='k'>new</span> <span title='f'>IntPtr</span><span title='p'>(</span><span title='p'>)</span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.queue<span title='o'> = </span>CL.<span title='f'>CreateCommandQueueWithProperties</span><span title='p'>(</span>context, devices<span title='p'>[</span>0<span title='p'>]</span>, <span title='k'>new</span> <span title='f'>IntPtr</span><span title='p'>(</span><span title='p'>)</span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// load kernels</span> <br> &emsp;&emsp;&emsp;<span title='k'>string</span> varDefines&emsp;&emsp;&emsp;= <span title='f'>GenerateDefines</span><span title='p'>(</span><span title='p'>)</span>; <span title='c'>// combine with other source strings to add common functions</span> <br> &emsp;&emsp;&emsp;<span title='k'>string</span> commonFuncSource&emsp;<span title='o'>  </span>= CLUtils.<span title='f'>LoadSource</span><span title='p'>(</span><span title='s'>"res/Kernels/common_funcs.cl"</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>string</span> pbdCommonSource&emsp;<span title='o'>  </span><span title='o'> = </span>CLUtils.<span title='f'>LoadSource</span><span title='p'>(</span><span title='s'>"res/Kernels/pbd_common.cl"</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>string</span> fluidProjectSource&emsp;= CLUtils.<span title='f'>LoadSource</span><span title='p'>(</span><span title='s'>"res/Kernels/fluid_project.cl"</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>string</span> solidProjectSource&emsp;= CLUtils.<span title='f'>LoadSource</span><span title='p'>(</span><span title='s'>"res/Kernels/solid_project.cl"</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLProgram pbdProgram&emsp;&emsp;<span title='o'> = </span>CLUtils.<span title='f'>BuildClProgram</span><span title='p'>(</span>context, devices, varDefines<span title='o'> + </span>commonFuncSource<span title='o'> + </span>pbdCommonSource<span title='o'>  </span> <span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLProgram fluidProgram&emsp;<span title='o'>  </span><span title='o'> = </span>CLUtils.<span title='f'>BuildClProgram</span><span title='p'>(</span>context, devices, varDefines<span title='o'> + </span>commonFuncSource<span title='o'> + </span>fluidProjectSource<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLProgram solidProgram&emsp;<span title='o'>  </span><span title='o'> = </span>CLUtils.<span title='f'>BuildClProgram</span><span title='p'>(</span>context, devices, varDefines<span title='o'> + </span>commonFuncSource<span title='o'> + </span>solidProjectSource<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_AssignParticleCells&emsp;= CL.<span title='f'>CreateKernel</span><span title='p'>(</span> pbdProgram<span title='o'>  </span> , <span title='s'>"assign_particle_cells"</span>&emsp;<span title='o'>  </span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_FindCellsStartAndEnd<span title='o'>  </span><span title='o'> = </span>CL.<span title='f'>CreateKernel</span><span title='p'>(</span> pbdProgram<span title='o'>  </span> , <span title='s'>"find_cells_start_and_end"</span><span title='o'>  </span> , <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_SortParticleIDsByCell<span title='o'>  </span>= CL.<span title='f'>CreateKernel</span><span title='p'>(</span> pbdProgram<span title='o'>  </span> , <span title='s'>"sort_particle_ids_by_cell"</span><span title='o'>  </span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_PredictPos&emsp;&emsp;&emsp;<span title='o'> = </span>CL.<span title='f'>CreateKernel</span><span title='p'>(</span> pbdProgram<span title='o'>  </span> , <span title='s'>"predict_positions"</span>&emsp;&emsp;<span title='o'>  </span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_CorrectPredictions&emsp;<span title='o'> = </span>CL.<span title='f'>CreateKernel</span><span title='p'>(</span> pbdProgram<span title='o'>  </span> , <span title='s'>"correct_predictions"</span>&emsp;&emsp;, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_UpdateVel&emsp;&emsp;&emsp;<span title='o'>  </span>= CL.<span title='f'>CreateKernel</span><span title='p'>(</span> pbdProgram<span title='o'>  </span> , <span title='s'>"update_velocity"</span>&emsp;&emsp;&emsp;, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_CalcLambdas&emsp;&emsp;&emsp;= CL.<span title='f'>CreateKernel</span><span title='p'>(</span> fluidProgram , <span title='s'>"calculate_lambdas"</span>&emsp;&emsp;<span title='o'>  </span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_FluidCorrect&emsp;&emsp;<span title='o'>  </span><span title='o'> = </span>CL.<span title='f'>CreateKernel</span><span title='p'>(</span> fluidProgram , <span title='s'>"calc_fluid_corrections"</span>&emsp; , <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_CalcVorticity&emsp;&emsp;<span title='o'>  </span>= CL.<span title='f'>CreateKernel</span><span title='p'>(</span> fluidProgram , <span title='s'>"calculate_vorticities"</span>&emsp;<span title='o'>  </span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_ApplyVortVisc&emsp;&emsp;<span title='o'>  </span>= CL.<span title='f'>CreateKernel</span><span title='p'>(</span> fluidProgram , <span title='s'>"apply_vorticity_viscosity"</span><span title='o'>  </span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_CorrectVel&emsp;&emsp;&emsp;<span title='o'> = </span>CL.<span title='f'>CreateKernel</span><span title='p'>(</span> fluidProgram , <span title='s'>"correct_fluid_vel"</span>&emsp;&emsp;<span title='o'>  </span>, <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.k_SolidCorrect&emsp;&emsp;<span title='o'>  </span><span title='o'> = </span>CL.<span title='f'>CreateKernel</span><span title='p'>(</span> solidProgram , <span title='s'>"calc_solid_corrections"</span>&emsp; , <span title='k'>out</span> result<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// create buffers</span> <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_Pos&emsp;&emsp;&emsp;&emsp;<span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeFloatBuffer</span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount<span title='o'> * </span>3<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_Vel&emsp;&emsp;&emsp;&emsp;<span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeFloatBuffer</span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount<span title='o'> * </span>3<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_ePos&emsp;&emsp;&emsp;&emsp;= CLUtils.<span title='f'>EnqueueMakeFloatBuffer</span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount<span title='o'> * </span>3<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_imass&emsp;&emsp;&emsp;<span title='o'>  </span><span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeFloatBuffer</span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount&emsp;<span title='o'>  </span>, 1<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_lambdas&emsp;&emsp;&emsp;<span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeFloatBuffer</span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount&emsp;<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_PosCorrection&emsp;<span title='o'>  </span><span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeFloatBuffer</span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount<span title='o'> * </span>3<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_Vorticities&emsp;&emsp;<span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeFloatBuffer</span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount<span title='o'> * </span>3<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_VelCorrection&emsp;<span title='o'>  </span><span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeFloatBuffer</span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount<span title='o'> * </span>3<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_phase&emsp;&emsp;&emsp;<span title='o'>  </span><span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeIntBuffer<span title='o'>  </span></span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount&emsp;<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_sortedParticleIDs<span title='o'>  </span><span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeIntBuffer<span title='o'>  </span></span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount&emsp;<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_cellIDsOfParticles<span title='o'>  </span>= CLUtils.<span title='f'>EnqueueMakeIntBuffer<span title='o'>  </span></span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount&emsp;<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_particleIDinCell&emsp;= CLUtils.<span title='f'>EnqueueMakeIntBuffer<span title='o'>  </span></span><span title='p'>(</span>context, queue,<span title='o'>  </span>particleCount&emsp;<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_cellStartAndEndIDs<span title='o'>  </span>= CLUtils.<span title='f'>EnqueueMakeIntBuffer<span title='o'>  </span></span><span title='p'>(</span>context, queue,<span title='o'>  </span>cellCount<span title='o'> * </span>2&emsp;<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;<span title='k'>this</span>.b_numParticlesPerCell<span title='o'> = </span>CLUtils.<span title='f'>EnqueueMakeIntBuffer<span title='o'>  </span></span><span title='p'>(</span>context, queue,<span title='o'>  </span>cellCount&emsp;&emsp;<span title='o'>  </span>, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// ensure fills are completed</span> <br> &emsp;&emsp;&emsp;CL.<span title='f'>Flush</span><span title='p'>(</span>queue<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CL.<span title='f'>Finish</span><span title='p'>(</span>queue<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>/////////////////////////////////</span> <br> &emsp;&emsp;&emsp;<span title='c'>// Set up OpenGL <span title='k'>for</span> rendering //</span> <br> &emsp;&emsp;&emsp;<span title='c'>/////////////////////////////////</span> <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;particleShader<span title='o'> = </span><span title='k'>new</span> <span title='f'>Shader</span><span title='p'>(</span><span title='s'>"res/Shaders/point_sphere.vert"</span>, <span title='s'>"res/Shaders/point_sphere.frag"</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='k'>float</span> <span title='p'>[</span><span title='p'>]</span> vertexData<span title='o'> = </span><span title='k'>new</span> <span title='k'>float</span> <span title='p'>[</span><span title='p'>]</span> <br> &emsp;&emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;&emsp;<span title='c'>//<span title='o'>  </span>X value&emsp;&emsp;&emsp;&emsp;&emsp;Y value&emsp;&emsp;<span title='o'>  </span>Z value</span> <br> &emsp;&emsp;&emsp;&emsp;-PARTICLE_RADIUS<span title='o'> / </span>2,&emsp;-PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; 0, <br> &emsp;&emsp;&emsp;&emsp; PARTICLE_RADIUS<span title='o'> / </span>2,&emsp;-PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; 0,<span title='o'>  </span><span title='c'>// triangle 1</span> <br> &emsp;&emsp;&emsp;&emsp; PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; 0, <br> &emsp;&emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;&emsp;-PARTICLE_RADIUS<span title='o'> / </span>2,&emsp;-PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; 0, <br> &emsp;&emsp;&emsp;&emsp; PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; 0,<span title='o'>  </span><span title='c'>// triangle 2</span> <br> &emsp;&emsp;&emsp;&emsp;-PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; PARTICLE_RADIUS<span title='o'> / </span>2,&emsp; 0, <br> &emsp;&emsp;&emsp;<span title='p'>}</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;quad_VAO&emsp;&emsp;&emsp;<span title='o'>  </span>= GLUtils.<span title='f'>GenVAO</span><span title='p'>(</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;quad_VBO&emsp;&emsp;&emsp;<span title='o'>  </span>= GLUtils.<span title='f'>GenVBO</span><span title='p'>(</span>vertexData<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;instancePositions_VBO<span title='o'> = </span>GLUtils.<span title='f'>GenVBO</span><span title='p'>(</span> posData <span title='p'>)</span>; <br> &emsp;&emsp;&emsp;instanceColours_VBO<span title='o'>  </span><span title='o'> = </span>GLUtils.<span title='f'>GenVBO</span><span title='p'>(</span> colourData <span title='p'>)</span>; <br> &emsp;&emsp;&emsp;GLUtils.VaoFloatAttrib&emsp;&emsp;<span title='p'>(</span>quad_VAO, quad_VBO&emsp;&emsp;&emsp; , 0, 3, 3, 0<span title='p'>)</span>; <span title='c'>// vertex positions</span> <br> &emsp;&emsp;&emsp;GLUtils.<span title='f'>VaoInstanceFloatAttrib</span><span title='p'>(</span>quad_VAO, instancePositions_VBO, 1, 3, 3, 0<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;GLUtils.<span title='f'>VaoInstanceFloatAttrib</span><span title='p'>(</span>quad_VAO, instanceColours_VBO<span title='o'>  </span>, 2, 3, 3, 0<span title='p'>)</span>; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='c'>// set pos, phase, colour, constraints, </span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>SetPos</span><span title='p'>(</span><span title='k'>int</span> id, <span title='k'>float</span> x, <span title='k'>float</span> y, <span title='k'>float</span> z<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;posData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span><span title='o'> = </span>x; <br> &emsp;&emsp;&emsp;posData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span><span title='o'> = </span>y; <br> &emsp;&emsp;&emsp;posData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='o'> = </span>z; <br> &emsp;&emsp;&emsp;posDirty<span title='o'> = </span>true; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>AddPos</span><span title='p'>(</span><span title='k'>int</span> id, <span title='k'>float</span> x, <span title='k'>float</span> y, <span title='k'>float</span> z<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;posData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span><span title='o'> += </span>x; <br> &emsp;&emsp;&emsp;posData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span><span title='o'> += </span>y; <br> &emsp;&emsp;&emsp;posData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='o'> += </span>z; <br> &emsp;&emsp;&emsp;posDirty<span title='o'> = </span>true; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='f'>Vector3 GetPos</span><span title='p'>(</span><span title='k'>int</span> id<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;<span title='k'>return</span> <span title='k'>new</span> <span title='f'>Vector3</span><span title='p'>(</span> posData<span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span>, posData<span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span>, posData<span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span> <span title='p'>)</span>; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>SetVel</span><span title='p'>(</span><span title='k'>int</span> id, <span title='k'>float</span> x, <span title='k'>float</span> y, <span title='k'>float</span> z<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;velData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span><span title='o'> = </span>x; <br> &emsp;&emsp;&emsp;velData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span><span title='o'> = </span>y; <br> &emsp;&emsp;&emsp;velData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='o'> = </span>z; <br> &emsp;&emsp;&emsp;velDirty<span title='o'> = </span>true; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>AddVel</span><span title='p'>(</span><span title='k'>int</span> id, <span title='k'>float</span> x, <span title='k'>float</span> y, <span title='k'>float</span> z<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;velData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span><span title='o'> += </span>x; <br> &emsp;&emsp;&emsp;velData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span><span title='o'> += </span>y; <br> &emsp;&emsp;&emsp;velData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='o'> += </span>z; <br> &emsp;&emsp;&emsp;velDirty<span title='o'> = </span>true; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='f'>Vector3 GetVel</span><span title='p'>(</span><span title='k'>int</span> id<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;<span title='k'>return</span> <span title='k'>new</span> <span title='f'>Vector3</span><span title='p'>(</span> velData<span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span>, velData<span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span>, velData<span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span> <span title='p'>)</span>; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>SetPhase</span><span title='p'>(</span><span title='k'>int</span> id, <span title='k'>int</span> phase<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;phaseData <span title='p'>[</span>id<span title='p'>]</span><span title='o'> = </span>phase; <br> &emsp;&emsp;&emsp;phaseDirty<span title='o'> = </span>true; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>SetColour</span><span title='p'>(</span><span title='k'>int</span> id, <span title='k'>float</span> r, <span title='k'>float</span> g, <span title='k'>float</span> b<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;colourData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span><span title='o'> = </span>r; <br> &emsp;&emsp;&emsp;colourData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span><span title='o'> = </span>g; <br> &emsp;&emsp;&emsp;colourData <span title='p'>[</span>id<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='o'> = </span>b; <br> &emsp;&emsp;&emsp;colourDirty<span title='o'> = </span>true; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>AddDistConstraint</span><span title='p'>(</span><span title='k'>int</span> id1, <span title='k'>int</span> id2, <span title='k'>float</span> dist<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;distanceConstraints.<span title='f'>Add</span><span title='p'>(</span> <span title='p'>(</span>id1, id2, dist<span title='p'>)</span> <span title='p'>)</span>; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>string</span> <span title='f'>GenerateDefines</span><span title='p'>(</span><span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;<span title='k'>string</span> defines<span title='o'> = </span><span title='s'>""</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define MAX_X "</span><span title='o'> + </span>MAX_X.<span title='f'>ToString</span><span title='p'>(</span><span title='s'>"0.0000"</span><span title='p'>)</span><span title='o'> + </span><span title='s'>"f"</span>; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define MAX_Y "</span><span title='o'> + </span>MAX_Y.<span title='f'>ToString</span><span title='p'>(</span><span title='s'>"0.0000"</span><span title='p'>)</span><span title='o'> + </span><span title='s'>"f"</span>; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define MAX_Z "</span><span title='o'> + </span>MAX_Z.<span title='f'>ToString</span><span title='p'>(</span><span title='s'>"0.0000"</span><span title='p'>)</span><span title='o'> + </span><span title='s'>"f"</span>; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define CELLCOUNT_X "</span><span title='o'> + </span>GridRowsX; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define CELLCOUNT_Y "</span><span title='o'> + </span>GridRowsY; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define CELLCOUNT_Z "</span><span title='o'> + </span>GridRowsZ; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define CELL_WIDTH "</span><span title='o'> + </span>GRID_CELL_WIDTH.<span title='f'>ToString</span><span title='p'>(</span><span title='s'>"0.0000"</span><span title='p'>)</span><span title='o'> + </span><span title='s'>"f"</span>; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define KERNEL_SIZE "</span><span title='o'> + </span>KERNEL_SIZE.<span title='f'>ToString</span><span title='p'>(</span><span title='s'>"0.0000"</span><span title='p'>)</span><span title='o'> + </span><span title='s'>"f"</span>; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define REST_DENSITY "</span><span title='o'> + </span>REST_DENSITY.<span title='f'>ToString</span><span title='p'>(</span><span title='s'>"0.0000"</span><span title='p'>)</span><span title='o'> + </span><span title='s'>"f"</span>; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define PHASE_LIQUID "</span><span title='o'> + </span>PHASE_LIQUID; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define PHASE_SOLID "</span><span title='o'> + </span>PHASE_SOLID; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span><span title='o'> + </span><span title='s'>"#define PHASE_STATIC "</span><span title='o'> + </span>PHASE_STATIC; <br> &emsp;&emsp;&emsp;defines<span title='o'> += </span><span title='s'>"\n"</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='k'>return</span> defines; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>Render</span><span title='p'>(</span>MainWindow world<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;<span title='k'>if</span> <span title='p'>(</span>colourDirty<span title='p'>)</span> <span title='p'>{</span> <br> &emsp;&emsp;&emsp;&emsp;GLUtils.<span title='f'>ReplaceBufferData</span><span title='p'>(</span>instanceColours_VBO, colourData <span title='p'>)</span>; <br> &emsp;&emsp;&emsp;&emsp;colourDirty<span title='o'> = </span>false; <br> &emsp;&emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp;&emsp;GLUtils.<span title='f'>ReplaceBufferData</span><span title='p'>(</span>instancePositions_VBO, posData <span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;particleShader.<span title='f'>Use</span><span title='p'>(</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;particleShader.<span title='f'>SetVector3</span><span title='p'>(</span><span title='s'>"lightPos"</span>, world.lightPos<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;particleShader.<span title='f'>SetMatrix4</span><span title='p'>(</span><span title='s'>"viewMatrix"</span>, world.character.activeCam.<span title='f'>GetViewMatrix</span><span title='p'>(</span><span title='p'>)</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;particleShader.<span title='f'>SetMatrix4</span><span title='p'>(</span><span title='s'>"projectionMatrix"</span>, world.character.activeCam.<span title='f'>GetProjectionMatrix</span><span title='p'>(</span><span title='p'>)</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;particleShader.<span title='f'>SetFloat</span><span title='p'>(</span><span title='s'>"particleRadius"</span>, PARTICLE_RADIUS<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;particleShader.<span title='f'>SetFloat</span><span title='p'>(</span><span title='s'>"maxX"</span>, MAX_X<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;GLUtils.<span title='f'>DrawInstancedVAO</span><span title='p'>(</span>quad_VAO, 6, ParticleCount<span title='p'>)</span>; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='k'>public</span> <span title='k'>void</span> <span title='f'>Update</span><span title='p'>(</span><span title='k'>float</span> delta, <span title='k'>float</span> shiftX<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;<span title='k'>if</span> <span title='p'>(</span>posDirty<span title='p'>)</span> <span title='p'>{</span> <br> &emsp;&emsp;&emsp;&emsp;CL.EnqueueWriteBuffer<<span title='k'>float</span>><span title='p'>(</span>queue, b_Pos, false, <span title='k'>new</span> <span title='f'>UIntPtr</span><span title='p'>(</span><span title='p'>)</span>, posData, null, <span title='k'>out</span> @event<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;&emsp;posDirty<span title='o'> = </span>false; <br> &emsp;&emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='k'>if</span> <span title='p'>(</span>velDirty<span title='p'>)</span> <span title='p'>{</span> <br> &emsp;&emsp;&emsp;&emsp;CL.EnqueueWriteBuffer<<span title='k'>float</span>><span title='p'>(</span>queue, b_Vel, false, <span title='k'>new</span> <span title='f'>UIntPtr</span><span title='p'>(</span><span title='p'>)</span>, velData, null, <span title='k'>out</span> @event<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;&emsp;velDirty<span title='o'> = </span>false; <br> &emsp;&emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='k'>if</span> <span title='p'>(</span>phaseDirty<span title='p'>)</span> <span title='p'>{</span> <br> &emsp;&emsp;&emsp;&emsp;CL.EnqueueWriteBuffer<<span title='k'>int</span>><span title='p'>(</span>queue, b_phase, false, <span title='k'>new</span> <span title='f'>UIntPtr</span><span title='p'>(</span><span title='p'>)</span>, phaseData, null, <span title='k'>out</span> @event<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;&emsp;phaseDirty<span title='o'> = </span>false; <br> &emsp;&emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueFillIntBuffer</span><span title='p'>(</span>queue, b_sortedParticleIDs, 0, ParticleCount<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueFillIntBuffer</span><span title='p'>(</span>queue, b_numParticlesPerCell, 0, cellCount<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueFillFloatBuffer</span><span title='p'>(</span>queue, b_PosCorrection, 0, ParticleCount<span title='o'> * </span>3<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// predict particle positions, then sort particle IDs <span title='k'>for</span> neighbour finding accordingly</span> <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_PredictPos&emsp;&emsp;&emsp; , ParticleCount<span title='o'>  </span>, delta, b_Pos, b_Vel, b_ePos, b_phase, GRAVITY.X, GRAVITY.Y, GRAVITY.Z<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_AssignParticleCells&emsp; , ParticleCount<span title='o'>  </span>, b_ePos, b_numParticlesPerCell, b_cellIDsOfParticles, b_particleIDinCell<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_FindCellsStartAndEnd<span title='o'>  </span> , cellCount&emsp;<span title='o'>  </span>, b_numParticlesPerCell, b_cellStartAndEndIDs<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_SortParticleIDsByCell<span title='o'>  </span>, ParticleCount<span title='o'>  </span>, b_particleIDinCell, b_cellStartAndEndIDs, b_cellIDsOfParticles, b_sortedParticleIDs<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// correct the predicted positions to satisfy fluid and contact constraints</span> <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_CalcLambdas&emsp;&emsp;&emsp;, ParticleCount<span title='o'>  </span>, b_ePos, b_imass, b_lambdas, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_FluidCorrect&emsp;&emsp;<span title='o'>  </span> , ParticleCount<span title='o'>  </span>, b_ePos, b_imass, b_lambdas, b_PosCorrection, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_SolidCorrect&emsp;&emsp;<span title='o'>  </span> , ParticleCount<span title='o'>  </span>, b_ePos, b_imass, b_PosCorrection, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_CorrectPredictions&emsp; , ParticleCount<span title='o'>  </span>, b_Pos, b_ePos, b_PosCorrection, b_phase<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;CpuSolveDistConstraints<span title='p'>(</span>0.2f, 2<span title='p'>)</span>; <span title='c'>// parameters: stiffness, iterations</span> <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// update particle velocities <span title='k'>using</span> corrected predictions, then correct fluid velocities <span title='k'>for</span> vorticity & viscosity</span> <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_UpdateVel&emsp;&emsp;&emsp;<span title='o'>  </span>, ParticleCount<span title='o'>  </span>, delta, b_Pos, b_Vel, b_ePos, b_phase, shiftX<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_CalcVorticity&emsp;&emsp;<span title='o'>  </span>, ParticleCount<span title='o'>  </span>, b_Pos, b_Vel, b_Vorticities, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_ApplyVortVisc&emsp;&emsp;<span title='o'>  </span>, ParticleCount<span title='o'>  </span>, b_Pos, b_Vel, b_Vorticities, b_VelCorrection, b_imass, delta, b_cellIDsOfParticles, b_cellStartAndEndIDs, b_sortedParticleIDs, b_phase<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CLUtils.<span title='f'>EnqueueKernel</span><span title='p'>(</span>queue, k_CorrectVel&emsp;&emsp;&emsp; , ParticleCount<span title='o'>  </span>, b_Vel, b_VelCorrection<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// read position and velocity data from GPU</span> <br> &emsp;&emsp;&emsp;CL.EnqueueReadBuffer<<span title='k'>float</span>><span title='p'>(</span>queue, b_Pos, false, <span title='k'>new</span> <span title='f'>UIntPtr</span><span title='p'>(</span><span title='p'>)</span>, posData, null, <span title='k'>out</span> @event<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CL.EnqueueReadBuffer<<span title='k'>float</span>><span title='p'>(</span>queue, b_Vel, false, <span title='k'>new</span> <span title='f'>UIntPtr</span><span title='p'>(</span><span title='p'>)</span>, velData, null, <span title='k'>out</span> @event<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;CL.<span title='f'>Flush</span><span title='p'>(</span>queue<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CL.<span title='f'>Finish</span><span title='p'>(</span>queue<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp; <br> &emsp;&emsp;<span title='c'>// distant constraint projection <span title='k'>is</span> performed on CPU because i can't figure <span title='k'>out</span> how to <span title='k'>do</span> it in OpenCL</span> <br> &emsp;&emsp;<span title='k'>private</span> <span title='k'>void</span> <span title='f'>CpuSolveDistConstraints</span><span title='p'>(</span><span title='k'>float</span> stiffness, <span title='k'>int</span> iterations<span title='p'>)</span> <br> &emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;stiffness<span title='o'> = </span>1<span title='o'> - </span>MathF.<span title='f'>Pow</span><span title='p'>(</span> 1<span title='o'> - </span>stiffness, 1f<span title='o'> / </span><span title='p'>(</span><span title='k'>float</span><span title='p'>)</span> iterations <span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// read estimated positions from the GPU</span> <br> &emsp;&emsp;&emsp;CL.EnqueueReadBuffer<<span title='k'>float</span>><span title='p'>(</span>queue, b_ePos, false, <span title='k'>new</span> <span title='f'>UIntPtr</span><span title='p'>(</span><span title='p'>)</span>, ePosData, null, <span title='k'>out</span> @event<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CL.<span title='f'>Flush</span><span title='p'>(</span>queue<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CL.<span title='f'>Finish</span><span title='p'>(</span>queue<span title='p'>)</span>; <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='k'>for</span> <span title='p'>(</span><span title='k'>int</span> i<span title='o'> = </span>0; i<span title='o'> < </span>iterations; i++<span title='p'>)</span> <br> &emsp;&emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;&emsp;<span title='k'>foreach</span><span title='p'>(</span> <span title='p'>(</span><span title='k'>int</span>, <span title='k'>int</span>, <span title='k'>float</span><span title='p'>)</span> constraint in distanceConstraints <span title='p'>)</span> <br> &emsp;&emsp;&emsp;&emsp;<span title='p'>{</span> <br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>int</span> p1<span title='o'> = </span>constraint.Item1; <br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>int</span> p2<span title='o'> = </span>constraint.Item2; <br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>float</span> restDist<span title='o'> = </span>constraint.Item3; <br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>float</span> imass1<span title='o'> = </span>1; <br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>float</span> imass2<span title='o'> = </span>1; <br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>if</span> <span title='p'>(</span>imass1<span title='o'> == </span>0<span title='o'> && </span>imass2<span title='o'> == </span>0<span title='p'>)</span> <span title='k'>return</span>; <br><span title='o'>  </span><br> &emsp;&emsp;&emsp;&emsp;&emsp;Vector3 epos1<span title='o'> = </span><span title='k'>new</span> <span title='f'>Vector3</span><span title='p'>(</span>ePosData <span title='p'>[</span>p1<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span>, ePosData <span title='p'>[</span>p1<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span>, ePosData <span title='p'>[</span>p1<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='p'>)</span>; <br> &emsp;&emsp;&emsp;&emsp;&emsp;Vector3 epos2<span title='o'> = </span><span title='k'>new</span> <span title='f'>Vector3</span><span title='p'>(</span>ePosData <span title='p'>[</span>p2<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span>, ePosData <span title='p'>[</span>p2<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span>, ePosData <span title='p'>[</span>p2<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='p'>)</span>; <br><span title='o'>  </span><br> &emsp;&emsp;&emsp;&emsp;&emsp;Vector3 dir<span title='o'> = </span>epos1<span title='o'> - </span>epos2; <br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>float</span> displacement<span title='o'> = </span>dir.Length<span title='o'> - </span>restDist; <br> &emsp;&emsp;&emsp;&emsp;&emsp;dir.<span title='f'>Normalize</span><span title='p'>(</span><span title='p'>)</span>; <br><span title='o'>  </span><br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>float</span> w1<span title='o'> = </span>imass1<span title='o'> / </span><span title='p'>(</span>imass1<span title='o'> + </span>imass2<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;&emsp;&emsp;<span title='k'>float</span> w2<span title='o'> = </span>imass2<span title='o'> / </span><span title='p'>(</span>imass1<span title='o'> + </span>imass2<span title='p'>)</span>; <br><span title='o'>  </span><br> &emsp;&emsp;&emsp;&emsp;&emsp;Vector3 correction1<span title='o'> = </span>-w1<span title='o'> * </span>displacement<span title='o'> * </span>dir; <br> &emsp;&emsp;&emsp;&emsp;&emsp;Vector3 correction2<span title='o'> = </span>+w2<span title='o'> * </span>displacement<span title='o'> * </span>dir; <br> &emsp;&emsp;&emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;&emsp;&emsp;ePosData<span title='p'>[</span>p1<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span><span title='o'> += </span>correction1.X<span title='o'> * </span>stiffness; <br> &emsp;&emsp;&emsp;&emsp;&emsp;ePosData<span title='p'>[</span>p1<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span><span title='o'> += </span>correction1.Y<span title='o'> * </span>stiffness; <br> &emsp;&emsp;&emsp;&emsp;&emsp;ePosData<span title='p'>[</span>p1<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='o'> += </span>correction1.Z<span title='o'> * </span>stiffness; <br> &emsp;&emsp;&emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;&emsp;&emsp;ePosData<span title='p'>[</span>p2<span title='o'> * </span>3<span title='o'> + </span>0<span title='p'>]</span><span title='o'> += </span>correction2.X<span title='o'> * </span>stiffness; <br> &emsp;&emsp;&emsp;&emsp;&emsp;ePosData<span title='p'>[</span>p2<span title='o'> * </span>3<span title='o'> + </span>1<span title='p'>]</span><span title='o'> += </span>correction2.Y<span title='o'> * </span>stiffness; <br> &emsp;&emsp;&emsp;&emsp;&emsp;ePosData<span title='p'>[</span>p2<span title='o'> * </span>3<span title='o'> + </span>2<span title='p'>]</span><span title='o'> += </span>correction2.Z<span title='o'> * </span>stiffness; <br> &emsp;&emsp;&emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp;&emsp;<span title='p'>}</span> <br> &emsp;&emsp;&emsp; <br> &emsp;&emsp;&emsp;<span title='c'>// write estimated positions back to the GPU</span> <br> &emsp;&emsp;&emsp;CL.EnqueueWriteBuffer<<span title='k'>float</span>><span title='p'>(</span>queue, b_ePos, false, <span title='k'>new</span> <span title='f'>UIntPtr</span><span title='p'>(</span><span title='p'>)</span>, ePosData, null, <span title='k'>out</span> @event<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CL.<span title='f'>Flush</span><span title='p'>(</span>queue<span title='p'>)</span>; <br> &emsp;&emsp;&emsp;CL.<span title='f'>Finish</span><span title='p'>(</span>queue<span title='p'>)</span>; <br> &emsp;&emsp;<span title='p'>}</span> <br><span title='o'>  </span><br> &emsp;<span title='p'>}</span> <br> <span title='p'>}</span> <br> <span title='c'>// end comment</span><style>*{font-family:'Courier New',Courier,monospace;background-color:#151220;color:#7fffd4}[title~="k"]{color:#a403c4}[title~="f"]{color:#00f}[title~="p"]{color:#ffff47}[title~="s"]{color:#adff2f}[title~="c"]{color:#bbbbbb}[title~="o"]{color:palevioletred;}</style>